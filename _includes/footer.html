<script>
  window.onload = function () {
    addBlankTargetToExternalLinks();
    htmlTableOfContents();
    addYTLinks();
};

function addBlankTargetToExternalLinks() {
    document.querySelectorAll('a[href]:not([href^="#"]):not([href^="/"]):not([href^="./"]):not([href^="../"])')
        .forEach(link => {
            link.setAttribute("target", "_blank");
            link.setAttribute("rel", "noopener noreferrer");
        });
}
  
function htmlTableOfContents(documentRef) {
    var documentRef = documentRef || document;
    var toc = documentRef.getElementById('toc');
    if (!toc) return;

    var headings = [].slice.call(documentRef.body.querySelectorAll('h1, h2, h3, h4, h5, h6'));
    var currentList = toc;
    var listStack = [{ level: 0, list: toc }];

    headings.forEach(function (heading) {
        var level = parseInt(heading.tagName.substring(1));
        var headingId = heading.getAttribute('id');
        if (!headingId) {
            headingId = 'heading-' + Math.random().toString(36).substr(2, 9);
            heading.setAttribute('id', headingId);
        }
        
        var link = documentRef.createElement('a');
        link.setAttribute('href', '#' + headingId);
        link.textContent = heading.textContent;

        var listItem = documentRef.createElement('li');
        listItem.appendChild(link);

        while (listStack.length > 0 && listStack[listStack.length - 1].level >= level) {
            listStack.pop();
        }

        if (listStack.length === 0) {
            currentList = toc;
        } else {
            currentList = listStack[listStack.length - 1].list;
        }

        var newList;
        if (listStack.length === 0 || listStack[listStack.length - 1].level < level) {
            newList = documentRef.createElement('ol');
            listItem.appendChild(newList);
            listStack.push({ level: level, list: newList });
        }

        currentList.appendChild(listItem);
       // Add 'top' link inside <small> tag in each heading
        var topLink = documentRef.createElement('span');
        topLink.setAttribute('class', "toplink no-print");
        topLink.innerHTML = '<a href="#top">top</a>';
        heading.appendChild(topLink);
    });
}

try {
    module.exports = htmlTableOfContents;
} catch (e) {
    // module.exports is not defined
}

  function addYTLinks(){
    document.querySelectorAll("a").forEach(link => {
        const ytRegex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/;
        const match = link.href.match(ytRegex);
        
        if (match) {
            const videoID = match[1];
            const newLink = document.createElement("a");
            newLink.className = "youtube-check";
            newLink.href = `https://i.ytimg.com/vi/${videoID}/hqdefault.jpg`;
            link.insertAdjacentElement("afterend", newLink);
        }
    });
  }

</script>
